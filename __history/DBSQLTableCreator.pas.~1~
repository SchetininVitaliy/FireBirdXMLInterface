unit DBSQLTableCreator;

interface
uses
  Classes,
  SQLTableCreator,
  Data.DB,
  IBX.IBDatabase,
  IBX.IBQuery,
  IBX.IBCustomDataSet,
  SQLTable;
type
  TDBSQLTableCreator = class(TSQLTableCreator)
      fDB : TIBDatabase;

      constructor Create(dbName:string; dbUser:string; dbPass:string;
                          dbCType:string);
      destructor Destroy;

      procedure CreateTableFromDB(tableName:string; var table:TSQLTable);

      procedure CreateDBTableFromTable(tableName:string; table:TSQLTable);
  end;
implementation
   constructor TDBSQLTableCreator.Create;
   begin
      fDB :=  TIBDatabase.Create(nil);
      fDB.Params.Clear;
      fDB.LoginPrompt:=False;
      fDB.DatabaseName:=dbName;
      fDB.Params.Add('user_name='+dbUser);
      fDB.Params.Add('password='+dbPass);
      fDB.Params.Add('lc_ctype='+dbCType);
      fDB.Connected:=True;
       //todo обработка исключений
   end;

   destructor  TDBSQLTableCreator.Destroy;
   begin
      fDB.Destroy;
   end;

   procedure TDBSQLTableCreator.CreateTableFromDB(tableName:string; var table:TSQLTable);
   var
      transCols, transRows: TIBTransaction;
      ibdsCols,ibdsRows: TIBDataSet;
      i_col :integer;
      row : TStringList;
   begin
      fDB.Open();
      //Выборка информации о колокнках таблицы
      transCols := TIBTransaction.Create(nil);
      transCols.DefaultDatabase := fDB;
      ibdsCols := TIBDataSet.Create(nil);
      ibdsCols.Database := fDB;
      ibdsCols.Transaction := transCols;
      //todo обработка исключений

      transCols.StartTransaction;

      ibdsCols.SelectSQL.Text := 'select '
                          +  'rf.rdb$field_name as column_name, '
                          +  'case f.rdb$field_type '
                          +    'when 14 then ''CHAR'' '
                          +    'when 37 then ''VARCHAR'' '
                          +    'when 8 then ''INTEGER'' '
                          +  'end as data_type, '
                          +  'f.rdb$field_length as length '
                          +  'from rdb$fields f '
                          +  'join rdb$relation_fields rf on rf.rdb$field_source = f.rdb$field_name '
                          +  'where rf.rdb$relation_name = ''' + tableName + ''' ;';
      Writeln(ibdsCols.SelectSQL.Text);
      ibdsCols.Active := true;
      //todo обрабока исключений
      while not ibdsCols.Eof do begin
         table.AddColumn(ibdsCols.FieldByName('column_name').AsString,
                          '',
                        ibdsCols.FieldByName('data_type').AsString);
         ibdsCols.Next;
      end;
      ibdsCols.Destroy;
      transCols.Destroy;

      //Выборка строк
      transRows := TIBTransaction.Create(nil);
      transRows.DefaultDatabase := fDB;
      ibdsRows := TIBDataSet.Create(nil);
      ibdsRows.Database := fDB;
      ibdsRows.Transaction := transRows;

      transRows.StartTransaction;

      ibdsRows.SelectSQL.Text := 'select * from ' + tableName + ' ;';
      ibdsRows.Active := true;
      //todo обрабока исключений
       row := TStringList.Create;
       while not ibdsRows.Eof do begin
          row.Clear;
          for i_col := 0 to ibdsRows.FieldCount - 1 do
             row.Add(ibdsRows.Fields[i_col].AsString);
          table.AddRow(row);
          ibdsRows.Next;
      end;
      ibdsRows.Destroy;
      transRows.Destroy;
      fDB.Close;
   end;

   procedure TDBSQLTableCreator.CreateDBTableFromTable(tableName:string; table:TSQLTable);
   var
    transTExist, transRows: TIBTransaction;
    ibdsTExist,ibdsRows: TIBDataSet;
   begin
      fDB.Open;
      //Если такой таблиц нет, то содаем ее
      transTExist := TIBTransaction.Create(nil);
      transTExist.DefaultDatabase := fDB;
      ibdsTExist := TIBDataSet.Create(nil);
      ibdsTExist.Database := fDB;
      ibdsTExist.Transaction := transTExist;

      transTExist.StartTransaction;

      ibdsTExist.SelectSQL.Text := 'select '
                          +  'rf.rdb$relation_name as table_name, '
                          +  'from rdb$fields f '
                          +  'join rdb$relation_fields rf on rf.rdb$field_source = f.rdb$field_name '
                          +  'where rf.rdb$relation_name = ''' + tableName + ''' ;';


      ibdsTExist.Destroy;
      transTExist.Destroy;

      fDB.Close;
   end;
end.
